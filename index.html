<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lumina PRO Admin</title>
    <style>
      body{margin:0;padding:12px;background:#0f1220;color:#fff;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
      .card{max-width:720px;margin:0 auto;background:rgba(255,255,255,.06);border-radius:12px;padding:14px}
      h1{margin:0 0 6px;color:#00f9f9;font-size:20px}
      .row{display:flex;gap:8px;flex-wrap:wrap}
      input{flex:1;min-width:220px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.3);color:#fff}
      button{padding:12px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
      .btn{background:#00f9f9;color:#000}
      .btn2{background:#444;color:#fff}
      .msg{margin-top:10px;padding:10px;border-radius:10px;display:none}
      .ok{display:block;background:rgba(0,204,0,.18);color:#00cc00}
      .err{display:block;background:rgba(255,68,68,.18);color:#ff4444}
      .item{margin-top:12px;background:rgba(0,0,0,.35);border-left:4px solid #00f9f9;border-radius:12px;padding:12px}
      .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:800;margin-left:8px}
      .bNew{background:#00f9f9;color:#000}
      .bMig{background:#ffa500;color:#000}
      .kv{margin-top:8px;background:rgba(255,255,255,.06);border-radius:10px;padding:10px}
      .k{font-size:11px;color:#aaa;text-transform:uppercase}
      .v{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;color:#00f9f9;word-break:break-all}
      .pw{margin-top:10px;border:1px solid rgba(0,204,0,.35);background:rgba(0,204,0,.08);border-radius:10px;padding:10px}
      .pw .v{color:#00cc00;font-size:18px;letter-spacing:2px}
      .actions{display:flex;gap:8px;margin-top:10px}
      .aOk{flex:1;background:#00cc00;color:#000}
      .aNo{flex:1;background:#ff4444;color:#fff}
      a{color:#00f9f9}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Lumina PRO Admin</h1>
      <div class="row">
        <input id="gasUrl" placeholder="GAS URL (…/exec)" />
        <input id="secret" type="password" placeholder="Admin secret" />
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn2" id="refreshBtn">Refresh</button>
        <button class="btn2" id="pingBtn">Ping</button>
        <button class="btn2" id="resetBtn">Reset</button>
      </div>
      <div id="msg" class="msg"></div>
      <div id="list"></div>
    </div>

    <script>
      // Set your own Apps Script Web App URL (…/exec) here or just paste it in the UI.
      // NOTE: If you previously used this page, your last URL may be saved in localStorage.
      const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbzqJL9OGsBeQpcIPSWBtb1KD9sfRDkxrqJiLgbNBRfS35PViiUZhN6zl8Wuvha9vRSJ4A/exec';
      let jsonpId = 0;
      function jsonp(url) {
        return new Promise((resolve, reject) => {
          const cb = 'cb_' + (++jsonpId) + '_' + Date.now();
          const s = document.createElement('script');
          const t = setTimeout(() => { cleanup(); reject(new Error('Timeout')); }, 20000);
          function cleanup() {
            clearTimeout(t);
            delete window[cb];
            if (s.parentNode) s.parentNode.removeChild(s);
          }
          window[cb] = (data) => { cleanup(); resolve(data); };
          s.onerror = () => { cleanup(); reject(new Error('Script load error')); };
          s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
          document.body.appendChild(s);
        });
      }

      function show(msg, type) {
        const el = document.getElementById('msg');
        el.textContent = msg;
        el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
      }

      function loadSaved() {
        const u = localStorage.getItem('lumina_gas_url') || DEFAULT_GAS_URL;
        const s = localStorage.getItem('lumina_admin_secret') || '';
        document.getElementById('gasUrl').value = u;
        document.getElementById('secret').value = s;
      }

      function save() {
        localStorage.setItem('lumina_gas_url', document.getElementById('gasUrl').value.trim());
        localStorage.setItem('lumina_admin_secret', document.getElementById('secret').value.trim());
        show('Saved', 'ok');
      }

      function getGasUrl_() {
        const fromInput = (document.getElementById('gasUrl').value || '').trim();
        if (fromInput) return fromInput;
        return (localStorage.getItem('lumina_gas_url') || '').trim();
      }

      function getSecret_() {
        const fromInput = (document.getElementById('secret').value || '').trim();
        if (fromInput) return fromInput;
        return (localStorage.getItem('lumina_admin_secret') || '').trim();
      }

      function resetSaved() {
        try {
          localStorage.removeItem('lumina_gas_url');
          localStorage.removeItem('lumina_admin_secret');
        } catch (e) {
          // ignore
        }
        loadSaved();
        show('Reset: defaults loaded', 'ok');
      }

      async function ping() {
        const gasUrl = getGasUrl_();
        if (!gasUrl) return show('Set GAS URL first', 'err');
        const url = gasUrl;
        try {
          const data = await jsonp(url);
          if (data && data.status && data.version) return show('OK: ' + data.status + ' | ' + data.version, 'ok');
          show('Response: ' + JSON.stringify(data), 'ok');
        } catch (e) {
          show(String(e.message || e), 'err');
        }
      }

      async function refresh() {
        const gasUrl = getGasUrl_();
        const secret = getSecret_();
        if (!gasUrl || !secret) return show('Set GAS URL and secret', 'err');
        const url = gasUrl + '?action=list&secret=' + encodeURIComponent(secret);
        document.getElementById('list').innerHTML = '';
        try {
          const data = await jsonp(url);
          if (data && data.status && !data.success) {
            throw new Error('Wrong endpoint/deploy (got status response). Open GAS /exec to check version.');
          }
          if (!data || !data.success) throw new Error((data && data.error) || 'Unauthorized (secret wrong or not set in GAS)');
          render(data.requests || []);
          show('OK', 'ok');
        } catch (e) {
          show(String(e.message || e), 'err');
        }
      }

      let lastByRowIndex = {};

      function render(items) {
        const root = document.getElementById('list');
        if (!items.length) {
          root.innerHTML = '<div style="margin-top:12px;color:#aaa">No pending requests</div>';
          return;
        }
        lastByRowIndex = {};
        items.forEach((r) => { if (r && r.rowIndex != null) lastByRowIndex[r.rowIndex] = r; });
        root.innerHTML = items.map(r => {
          const isMig = r.type === 'MIGRATION';
          const badge = isMig ? '<span class="badge bMig">MIGRATION</span>' : '<span class="badge bNew">NEW</span>';
          const border = isMig ? '#ffa500' : '#00f9f9';
          const payLink = 'https://www.paypal.com/activity/payment/' + encodeURIComponent(r.transactionId || '');
          return `
            <div class="item" id="row_${r.rowIndex}" style="border-left-color:${border}">
              <div style="font-weight:800">${r.email || ''}${badge}</div>
              <div class="kv"><div class="k">Transaction</div><div class="v"><a href="${payLink}" target="_blank" rel="noreferrer">${r.transactionId || ''}</a></div></div>
              <div class="kv"><div class="k">Payment email</div><div class="v">${r.paymentEmail || ''}</div></div>
              <div class="kv"><div class="k">UID</div><div class="v">${r.uid || ''}</div></div>
              <div class="pw"><div class="k">Password</div><div class="v">${r.password || ''}</div></div>
              <div class="actions">
                <button class="aOk" onclick="approve(${r.rowIndex})">Approve & Send</button>
                <button class="aNo" onclick="rejectReq(${r.rowIndex})">Reject</button>
              </div>
            </div>
          `;
        }).join('');
      }

      async function approve(rowIndex) {
        const gasUrl = (localStorage.getItem('lumina_gas_url') || '').trim();
        const secret = (localStorage.getItem('lumina_admin_secret') || '').trim();
        const url = gasUrl + '?action=approve&secret=' + encodeURIComponent(secret) + '&rowIndex=' + rowIndex;
        try {
          const data = await jsonp(url);
          if (!data || !data.success) throw new Error((data && data.error) || 'Failed');
          const email = (lastByRowIndex[rowIndex] && lastByRowIndex[rowIndex].email) ? lastByRowIndex[rowIndex].email : '';
          show('Sent ' + (email ? ('to ' + email) : ''), 'ok');
          setTimeout(refresh, 1200);
        } catch (e) {
          show(String(e.message || e), 'err');
        }
      }

      async function rejectReq(rowIndex) {
        if (!confirm('Reject?')) return;
        const gasUrl = (localStorage.getItem('lumina_gas_url') || '').trim();
        const secret = (localStorage.getItem('lumina_admin_secret') || '').trim();
        const url = gasUrl + '?action=reject&secret=' + encodeURIComponent(secret) + '&rowIndex=' + rowIndex;
        try {
          const data = await jsonp(url);
          if (!data || !data.success) throw new Error((data && data.error) || 'Failed');
          show('Rejected', 'ok');
          setTimeout(refresh, 800);
        } catch (e) {
          show(String(e.message || e), 'err');
        }
      }

      document.getElementById('saveBtn').addEventListener('click', () => { save(); refresh(); });
      document.getElementById('refreshBtn').addEventListener('click', refresh);
      document.getElementById('pingBtn').addEventListener('click', ping);
      document.getElementById('resetBtn').addEventListener('click', resetSaved);
      loadSaved();
    </script>
  </body>
</html>

