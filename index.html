<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lumina PRO - Pannello Admin</title>
    <style>
      body{margin:0;padding:12px;background:#0f1220;color:#fff;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial}
      .card{max-width:720px;margin:0 auto;background:rgba(255,255,255,.06);border-radius:12px;padding:14px}
      h1{margin:0 0 6px;color:#00f9f9;font-size:20px}
      .row{display:flex;gap:8px;flex-wrap:wrap}
      input{flex:1;min-width:220px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.3);color:#fff}
      button{padding:12px 14px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
      .btn{background:#00f9f9;color:#000}
      .btn2{background:#444;color:#fff}
      .msg{margin-top:10px;padding:10px;border-radius:10px;display:none}
      .ok{display:block;background:rgba(0,204,0,.18);color:#00cc00}
      .err{display:block;background:rgba(255,68,68,.18);color:#ff4444}
      .item{margin-top:12px;background:rgba(0,0,0,.35);border-left:4px solid #00f9f9;border-radius:12px;padding:12px}
      .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;font-weight:800;margin-left:8px}
      .bNew{background:#00f9f9;color:#000}
      .bMig{background:#ffa500;color:#000}
      .kv{margin-top:8px;background:rgba(255,255,255,.06);border-radius:10px;padding:10px}
      .k{font-size:11px;color:#aaa;text-transform:uppercase}
      .v{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;color:#00f9f9;word-break:break-all}
      .pw{margin-top:10px;border:1px solid rgba(0,204,0,.35);background:rgba(0,204,0,.08);border-radius:10px;padding:10px}
      .pw .v{color:#00cc00;font-size:18px;letter-spacing:2px}
      .actions{display:flex;gap:8px;margin-top:10px}
      .aOk{flex:1;background:#00cc00;color:#000}
      .aNo{flex:1;background:#ff4444;color:#fff}
      a{color:#00f9f9}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Lumina PRO - Pannello Admin</h1>
      <div class="row">
        <input id="gasUrl" placeholder="URL GAS (…/exec)" />
        <input id="secret" type="password" placeholder="Segreto admin" />
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="saveBtn">Salva</button>
        <button class="btn2" id="refreshBtn">Aggiorna</button>
        <button class="btn2" id="pingBtn">Ping</button>
        <button class="btn2" id="resetBtn">Reset</button>
      </div>
      <div id="msg" class="msg"></div>
      <div id="list"></div>
    </div>

    <script>
      // Set your own Apps Script Web App URL (…/exec) here or just paste it in the UI.
      // NOTE: If you previously used this page, your last URL may be saved in localStorage.
      // IMPORTANT: do not hardcode your real /exec URL in the repo.
      // Leave this empty and paste it in the UI (it will be saved in localStorage).
      const DEFAULT_GAS_URL = '';
      let jsonpId = 0;
      function jsonp(url) {
        return new Promise((resolve, reject) => {
          const cb = 'cb_' + (++jsonpId) + '_' + Date.now();
          const s = document.createElement('script');
          const t = setTimeout(() => { cleanup(); reject(new Error('Timeout')); }, 20000);
          function cleanup() {
            clearTimeout(t);
            delete window[cb];
            if (s.parentNode) s.parentNode.removeChild(s);
          }
          window[cb] = (data) => { cleanup(); resolve(data); };
          s.onerror = () => { cleanup(); reject(new Error('Script load error')); };
          s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb;
          document.body.appendChild(s);
        });
      }

      function show(msg, type) {
        const el = document.getElementById('msg');
        el.textContent = msg;
        el.className = 'msg ' + (type === 'ok' ? 'ok' : 'err');
      }

      function loadSaved() {
        const u = localStorage.getItem('lumina_gas_url') || DEFAULT_GAS_URL;
        const s = localStorage.getItem('lumina_admin_secret') || '';
        document.getElementById('gasUrl').value = u;
        document.getElementById('secret').value = s;
      }

      function save() {
        localStorage.setItem('lumina_gas_url', document.getElementById('gasUrl').value.trim());
        localStorage.setItem('lumina_admin_secret', document.getElementById('secret').value.trim());
        show('Salvato', 'ok');
      }

      function getGasUrl_() {
        const fromInput = (document.getElementById('gasUrl').value || '').trim();
        if (fromInput) return fromInput;
        return (localStorage.getItem('lumina_gas_url') || '').trim();
      }

      function getSecret_() {
        const fromInput = (document.getElementById('secret').value || '').trim();
        if (fromInput) return fromInput;
        return (localStorage.getItem('lumina_admin_secret') || '').trim();
      }

      function resetSaved() {
        try {
          localStorage.removeItem('lumina_gas_url');
          localStorage.removeItem('lumina_admin_secret');
        } catch (e) {
          // ignore
        }
        loadSaved();
        show('Reset: valori predefiniti caricati', 'ok');
      }

      async function ping() {
        const gasUrl = getGasUrl_();
        if (!gasUrl) return show('Inserisci prima l\'URL GAS', 'err');
        const url = gasUrl;
        try {
          const data = await jsonp(url);
          if (data && data.status && data.version) return show('OK: ' + data.status + ' | ' + data.version, 'ok');
          show('Response: ' + JSON.stringify(data), 'ok');
        } catch (e) {
          show(String(e.message || e), 'err');
        }
      }

      async function refresh() {
        const gasUrl = getGasUrl_();
        const secret = getSecret_();
        if (!gasUrl || !secret) return show('Inserisci URL GAS e segreto admin', 'err');
        const url = gasUrl + '?action=list&secret=' + encodeURIComponent(secret);
        document.getElementById('list').innerHTML = '';
        try {
          const data = await jsonp(url);
          if (data && data.status && !data.success) {
            throw new Error('Wrong endpoint/deploy (got status response). Open GAS /exec to check version.');
          }
          if (!data || !data.success) {
            const err = (data && data.error) || 'unauthorized';
            const msg = (data && data.message) ? (err + ': ' + data.message) : err;
            throw new Error(msg);
          }
          render((data.items || data.requests || []));
          show('OK', 'ok');
        } catch (e) {
          show(String(e.message || e), 'err');
        }
      }

      let lastByRowIndex = {};

      function render(items) {
        const root = document.getElementById('list');
        if (!items.length) {
          root.innerHTML = '<div style="margin-top:12px;color:#aaa">Nessuna richiesta in attesa</div>';
          return;
        }
        lastByRowIndex = {};
        items.forEach((r) => {
          const key = (r && (r.row != null ? r.row : r.rowIndex));
          if (key != null) lastByRowIndex[key] = r;
        });
        const headerNote = `
          <div class="kv" style="margin-top:12px">
            <div class="k">Informazioni</div>
            <div class="v" style="color:#ffa500;white-space:normal;font-family:inherit">
              Questa pagina mostra solo le richieste <b>in attesa</b>. Se una richiesta è qui elencata, <b>l'email con la password NON è ancora stata inviata</b>.
              <div style="margin-top:8px;color:#cfefff;font-size:12px;line-height:1.4">
                <b>Quando approvare:</b> Usa <b>Approva e Invia</b> solo quando il controllo pagamento è <b>OK</b> (verifica PayPal, Colletta o GitHub trovata e corrispondente).
              </div>
              <div style="margin-top:6px;color:#cfefff;font-size:12px;line-height:1.4">
                <b>Quando NON approvare:</b> Se il controllo è <b>NON TROVATO</b> o <b>NO</b>, non approvare: il sistema non ha trovato un pagamento corrispondente (email, nome, cognome o importo non coincidono).
              </div>
              <div style="margin-top:6px;color:#cfefff;font-size:12px;line-height:1.4">
                <b>Metodi:</b> PayPal (pagamento diretto), Colletta PayPal (raccolta fondi), GitHub Sponsors.
              </div>
            </div>
          </div>
        `;
        root.innerHTML = headerNote + items.map(r => {
          const isMig = (String(r.type || '').toUpperCase() === 'MIGRATION') || (String(r.action || '').toLowerCase() === 'migration');
          const badge = isMig ? '<span class="badge bMig">MIGRATION</span>' : '<span class="badge bNew">NEW</span>';
          const border = isMig ? '#ffa500' : '#00f9f9';
          const txn = r.transactionId || r.transaction_id || '';
          const payFirst = r.paypalFirstName || r.paypal_first_name || '';
          const payLast = r.paypalLastName || r.paypal_last_name || '';
          const payName = String((payFirst + ' ' + payLast) || '').trim();
          const ppStatus = r.paypal_check_status || r.paypalCheckStatus || '';
          const ppAmount = r.paypal_check_amount || r.paypalCheckAmount || '';
          const ppCurrency = r.paypal_check_currency || r.paypalCheckCurrency || '';
          const ppAmountOk = r.paypal_check_amount_ok || r.paypalCheckAmountOk || '';
          const ppPayer = r.paypal_check_payer || r.paypalCheckPayer || '';
          const ppSubj = r.paypal_check_subject || r.paypalCheckSubject || '';
          const ppDate = r.paypal_check_date || r.paypalCheckDate || '';
          const ppTxn = r.paypal_check_extracted_txn || r.paypalCheckExtractedTxn || '';

          const method = (r.payment_method || r.paymentMethod || 'paypal');
          const ghUser = r.github_user || r.githubUser || '';
          const ghStatus = r.github_check_status || r.githubCheckStatus || '';
          const ghAmount = r.github_check_amount || r.githubCheckAmount || '';
          const ghCurrency = r.github_check_currency || r.githubCheckCurrency || '';
          const ghTier = r.github_check_tier || r.githubCheckTier || '';
          const payLink = txn ? ('https://www.paypal.com/activity/payment/' + encodeURIComponent(txn || '')) : '';
          const rowId = (r.row != null ? r.row : r.rowIndex);
          const methodNorm = (String(method || 'paypal').toLowerCase() === 'github') ? 'github' : ((String(method || '').toLowerCase() === 'colletta') ? 'colletta' : 'paypal');
          const methodLabel = methodNorm === 'github' ? 'GitHub Sponsors' : (methodNorm === 'colletta' ? 'Colletta PayPal' : 'PayPal');
          const txnRow = txn
            ? `<div class="kv"><div class="k">Codice transazione</div><div class="v"><a href="${payLink}" target="_blank" rel="noreferrer">${txn}</a></div></div>`
            : `<div class="kv"><div class="k">Codice transazione</div><div class="v">(nessuno)</div></div>`;
          const payNameRow = payName
            ? `<div class="kv"><div class="k">Nome partecipante</div><div class="v">${payName}</div></div>`
            : '';
          const ppLabel = (ppStatus === 'OK') ? 'OK' : (ppStatus === 'NO' ? 'NO' : (ppStatus === 'NOT_FOUND' ? 'NON TROVATO' : (ppStatus === 'ERROR' ? 'ERRORE' : '')));
          const ppColor = (ppStatus === 'OK') ? '#00cc00' : (ppStatus === 'NO' ? '#ff4444' : (ppStatus === 'NOT_FOUND' ? '#ffa500' : (ppStatus === 'ERROR' ? '#ff4444' : '#00f9f9')));
          const checkLabelIt = (ppStatus === 'OK') ? 'OK' : (ppStatus === 'NO' ? 'NO' : (ppStatus === 'NOT_FOUND' ? 'NON TROVATO' : (ppStatus === 'ERROR' ? 'ERRORE' : '')));
          const ppDetails = [
            (ppAmount ? ('Importo: ' + ppAmount + (ppCurrency ? (' ' + ppCurrency) : '')) : ''),
            (ppAmountOk ? ('Importo accettato: ' + ppAmountOk) : ''),
            (ppPayer ? ('Pagante: ' + ppPayer) : ''),
            (ppTxn ? ('Txn (da mail): ' + ppTxn) : ''),
            (ppDate ? ('Data: ' + ppDate) : ''),
            (ppSubj ? ('Oggetto: ' + ppSubj) : '')
          ].filter(Boolean).join(' | ');
          const ppCheckLabel = methodNorm === 'colletta' ? 'Controllo Colletta' : 'Controllo PayPal';
          const ppRow = (methodNorm !== 'github') && ppLabel
            ? `<div class="kv"><div class="k">${ppCheckLabel}</div><div class="v"><span style="color:${ppColor};font-weight:900">${checkLabelIt}</span>${ppDetails ? ('<div style="margin-top:6px;color:#cfefff;font-size:12px;line-height:1.35">' + ppDetails + '</div>') : ''}</div></div>`
            : '';

          const ghLabel = (ghStatus === 'OK') ? 'OK' : (ghStatus === 'NO' ? 'NO' : (ghStatus === 'NOT_FOUND' ? 'NOT FOUND' : (ghStatus === 'ERROR' ? 'ERROR' : '')));
          const ghColor = (ghStatus === 'OK') ? '#00cc00' : (ghStatus === 'NO' ? '#ff4444' : (ghStatus === 'NOT_FOUND' ? '#ffa500' : (ghStatus === 'ERROR' ? '#ff4444' : '#00f9f9')));
          const ghDetails = [
            (ghUser ? ('Utente: ' + ghUser) : ''),
            (ghAmount ? ('Importo: ' + ghAmount + (ghCurrency ? (' ' + ghCurrency) : '')) : ''),
            (ghTier ? ('Tier: ' + ghTier) : '')
          ].filter(Boolean).join(' | ');
          const ghRow = (method === 'github') && ghLabel
            ? `<div class="kv"><div class="k">GitHub Sponsors</div><div class="v"><span style="color:${ghColor};font-weight:900">${ghLabel}</span>${ghDetails ? ('<div style="margin-top:6px;color:#cfefff;font-size:12px;line-height:1.35">' + ghDetails + '</div>') : ''}</div></div>`
            : '';

          const checkStatus = (methodNorm === 'github') ? String(ghStatus || '') : String(ppStatus || '');
          const checkLabel = (checkStatus === 'OK') ? 'OK' : (checkStatus === 'NO' ? 'NO' : (checkStatus === 'NOT_FOUND' ? 'NOT FOUND' : (checkStatus === 'ERROR' ? 'ERROR' : 'UNKNOWN')));
          const checkColor = (checkLabel === 'OK') ? '#00cc00' : (checkLabel === 'NO' ? '#ff4444' : (checkLabel === 'NOT FOUND' ? '#ffa500' : (checkLabel === 'ERROR' ? '#ff4444' : '#00f9f9')));
          const statusHelp = (checkLabel === 'OK')
            ? 'Pagamento trovato e corrispondente. Puoi approvare per inviare l\'email con la password.'
            : (checkLabel === 'NOT FOUND')
              ? 'Nessun pagamento trovato. NON approvare: l\'email con la password NON deve essere inviata.'
              : (checkLabel === 'NO')
                ? 'Il controllo ha trovato qualcosa ma NON corrisponde (utente/email/nome/importo diversi). NON approvare.'
                : (checkLabel === 'ERROR')
                  ? 'Errore nel controllo. Verifica la configurazione (Gmail / token GitHub) prima di approvare.'
                  : 'Controllo pagamento non ancora disponibile.';
          const statusRow = `
            <div class="kv">
              <div class="k">Stato</div>
              <div class="v" style="white-space:normal;font-family:inherit">
                <span style="color:#ffa500;font-weight:900">IN ATTESA</span> — email password <b>NON INVIATA</b><br/>
                <div style="margin-top:6px;color:#cfefff;font-size:12px;line-height:1.35">
                  Metodo: <b>${methodLabel}</b> | Controllo: <span style="color:${checkColor};font-weight:900">${checkLabel}</span><br/>
                  ${statusHelp}
                </div>
              </div>
            </div>
          `;

          const methodRow = (methodNorm === 'github')
            ? `<div class="kv"><div class="k">Metodo pagamento</div><div class="v">GitHub Sponsors</div></div>
               <div class="kv"><div class="k">Username GitHub</div><div class="v">${ghUser || '(mancante)'}</div></div>`
            : (methodNorm === 'colletta')
            ? `<div class="kv"><div class="k">Metodo pagamento</div><div class="v">Colletta PayPal</div></div>
               <div class="kv"><div class="k">Email pagamento</div><div class="v">${r.paymentEmail || r.payment_email || ''}</div></div>`
            : `<div class="kv"><div class="k">Metodo pagamento</div><div class="v">PayPal</div></div>
               <div class="kv"><div class="k">Email pagamento PayPal</div><div class="v">${r.paymentEmail || r.payment_email || ''}</div></div>`;
          return `
            <div class="item" id="row_${rowId}" style="border-left-color:${border}">
              <div style="font-weight:800">${r.email || ''}${badge}</div>
              <div class="kv"><div class="k">Riga</div><div class="v">${rowId}</div></div>
              ${statusRow}
              ${methodRow}
              ${payNameRow}
              ${ppRow}
              ${ghRow}
              ${txnRow}
              <div class="kv"><div class="k">UID</div><div class="v">${r.uid || ''}</div></div>
              <div class="actions">
                <button class="aOk" onclick="approve(${rowId})">Approva e Invia</button>
                <button class="aNo" onclick="rejectReq(${rowId})">Rifiuta</button>
              </div>
            </div>
          `;
        }).join('');
      }

      async function approve(rowIndex) {
        const gasUrl = getGasUrl_();
        const secret = getSecret_();
        if (!gasUrl || !secret) return show('Inserisci URL GAS e segreto admin', 'err');
        // Support both scripts: lite uses "row", legacy uses "rowIndex"
        const url = gasUrl + '?action=approve&secret=' + encodeURIComponent(secret) + '&row=' + rowIndex + '&rowIndex=' + rowIndex;
        try {
          const data = await jsonp(url);
          if (!data || !data.success) {
            const err = (data && data.error) || 'Failed';
            const msg = (data && data.message) ? (err + ': ' + data.message) : err;
            throw new Error(msg);
          }
          const email = (lastByRowIndex[rowIndex] && lastByRowIndex[rowIndex].email) ? lastByRowIndex[rowIndex].email : '';
          show('Inviata a ' + (email ? email : ''), 'ok');
          setTimeout(refresh, 1200);
        } catch (e) {
          show(String(e.message || e), 'err');
        }
      }

      async function rejectReq(rowIndex) {
        if (!confirm('Rifiutare questa richiesta?')) return;
        const gasUrl = getGasUrl_();
        const secret = getSecret_();
        if (!gasUrl || !secret) return show('Inserisci URL GAS e segreto admin', 'err');
        // Support both scripts: lite uses "row", legacy uses "rowIndex"
        const url = gasUrl + '?action=reject&secret=' + encodeURIComponent(secret) + '&row=' + rowIndex + '&rowIndex=' + rowIndex;
        try {
          const data = await jsonp(url);
          if (!data || !data.success) {
            const err = (data && data.error) || 'Failed';
            const msg = (data && data.message) ? (err + ': ' + data.message) : err;
            throw new Error(msg);
          }
          show('Richiesta rifiutata', 'ok');
          setTimeout(refresh, 800);
        } catch (e) {
          show(String(e.message || e), 'err');
        }
      }

      document.getElementById('saveBtn').addEventListener('click', () => { save(); setTimeout(() => refresh(), 0); });
      document.getElementById('refreshBtn').addEventListener('click', refresh);
      document.getElementById('pingBtn').addEventListener('click', ping);
      document.getElementById('resetBtn').addEventListener('click', resetSaved);
      loadSaved();
    </script>
  </body>
</html>

